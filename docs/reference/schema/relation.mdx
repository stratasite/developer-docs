# Relation Model Schema (rel.*.yml)

Complete schema for relationship definition files.

## Overview

Relation models define joins between tables in your semantic model.

## File Pattern

`models/**/rel.{domain}.yml`

## Schema

```yaml
# Required
datasource: string             # Datasource key

# Relationship definitions
relationship_name:
  left: string                 # Required: Left table name
  right: string                # Required: Right table name
  sql: string                  # Required: Join condition (SQL expression)
  cardinality: string          # Required: one_to_one, one_to_many, many_to_one
  
  # Optional
  join: string                 # Join type: left, right, inner, full (default: inner)
  allow_measure_expansion: boolean # Optional (default: false)
```

## Required Fields

### datasource

Datasource key these relationships belong to.

```yaml
datasource: tpcds
```

**Note:** Relationships are scoped to a single datasource. Cross-datasource joins are not supported.

### Relationship Definition

Each relationship requires:

#### left

Left table name. Must match table `name` in `tbl.*.yml`.

```yaml
left: Store Sales
```

#### right

Right table name. Must match table `name` in `tbl.*.yml`.

```yaml
right: Store
```

#### sql

Join condition as SQL expression. Use `left.` and `right.` prefixes.

```yaml
sql: left.ss_store_sk = right.s_store_sk
```

**Compound joins:**
```yaml
sql: left.id = right.user_id AND left.tenant_id = right.tenant_id
```

#### cardinality

Relationship type.

```yaml
cardinality: many_to_one
```

**Options:**
- `one_to_one` - One-to-one relationship
- `one_to_many` - One-to-many relationship
- `many_to_one` - Many-to-one relationship (most common)

**Note:** `many_to_many` is not supported. Use junction tables.

## Optional Fields

### join

Join type. Default is `inner`.

```yaml
join: left  # left, right, inner, full
```

**Options:**
- `inner` - INNER JOIN (default)
- `left` - LEFT JOIN (optional relationships)
- `right` - RIGHT JOIN
- `full` - FULL OUTER JOIN

### allow_measure_expansion

Allow measure aggregation from low-cardinality table. Default: `false`.

```yaml
allow_measure_expansion: true
```

**Warning:** Can cause overcounting. Use carefully.

## Complete Example

```yaml
datasource: tpcds

# Store Sales to Date Dimension
store_sales_sold_date:
  left: Store Sales
  right: Date
  sql: left.ss_sold_date_sk = right.d_date_sk
  cardinality: many_to_one

# Store Sales to Customer Dimension
store_sales_customer:
  left: Store Sales
  right: Customer
  sql: left.ss_customer_sk = right.c_customer_sk
  cardinality: many_to_one

# Store Returns to Reason (optional, left join)
store_returns_reason:
  left: Store Returns
  right: Reason
  join: left
  sql: left.sr_reason_sk = right.r_reason_sk
  cardinality: many_to_one
```

## Common Patterns

### Fact to Dimension (many_to_one)

```yaml
sales_customer:
  left: Sales
  right: Customer
  sql: left.customer_id = right.id
  cardinality: many_to_one
```

### Optional Relationship (LEFT JOIN)

```yaml
orders_promotion:
  left: Orders
  right: Promotion
  join: left
  sql: left.promotion_id = right.id
  cardinality: many_to_one
```

### Compound Join

```yaml
user_roles:
  left: Users
  right: Roles
  sql: left.id = right.user_id AND left.tenant_id = right.tenant_id
  cardinality: one_to_many
```

## Best Practices

1. **Group related relationships** - One file per domain
2. **Use descriptive names** - `store_sales_customer` not `rel1`
3. **Match table names exactly** - Use `name` from table definitions
4. **Prefer many_to_one** - Most common pattern
5. **Use left joins** - For optional relationships
6. **Document relationships** - Add comments explaining joins

## Next Steps

- [Learn about relationships](/docs/guides/relationships)
- [Understand cardinality](/docs/semantic-model/relationships/cardinality)
- [Read about join types](/docs/semantic-model/relationships/join-types)
