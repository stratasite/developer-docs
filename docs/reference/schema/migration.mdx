# Migration Schema (migrations/*.yml)

Complete schema for migration files.

## Overview

Migrations track changes to your semantic model over time. They enable safe renaming and swapping of entities.

## File Pattern

`migrations/YYYYMMDDHHMMSS_{operation}_{entity}_{from}_to_{to}.yml`

## Schema

### Rename Migration

```yaml
- type: rename
  hook: string                  # Required: pre or post
  entity: string                # Required: dimension, measure, table, datasource
  from: string                  # Required: Current entity name
  to: string                    # Required: New entity name
```

### Swap Migration

```yaml
- type: swap
  hook: string                  # Required: pre or post
  entity: string                # Required: dimension, measure, table (not datasource)
  from: string                  # Required: Source entity name
  to: string                    # Required: Target entity name
```

## Required Fields

### type

Migration type.

```yaml
type: rename  # or swap
```

### hook

When the migration runs.

```yaml
hook: pre  # or post
```

**Options:**
- `pre` - Runs before processing YAML files (default for rename)
- `post` - Runs after processing YAML files (default for swap)

### entity

Entity type being migrated.

```yaml
entity: dimension  # dimension, measure, table, datasource
```

**For rename:**
- `dimension`
- `measure`
- `table`
- `datasource`

**For swap:**
- `dimension`
- `measure`
- `table`
- **Note:** `datasource` not supported for swap

### from

Current/source entity name.

```yaml
from: Store Name
```

### to

New/target entity name.

```yaml
to: Store Location Name
```

## Complete Examples

### Rename Dimension (Pre Hook)

```yaml
- type: rename
  hook: pre
  entity: dimension
  from: Store Name
  to: Store Location Name
```

**Workflow:**
1. Migration renames entity
2. YAML files processed with new name
3. Old name no longer exists

### Rename Table (Pre Hook)

```yaml
- type: rename
  hook: pre
  entity: table
  from: Orders
  to: Customer Orders
```

### Swap Measure (Post Hook)

```yaml
- type: swap
  hook: post
  entity: measure
  from: Old Revenue
  to: New Revenue
```

**Workflow:**
1. YAML files processed with original names
2. Migration swaps references
3. Old entity replaced with new

## Migration Hooks

### Pre Hook

Runs before YAML processing. Use for:
- Renaming entities referenced in YAML
- Preventing deletion of old entities
- Most common for renames

### Post Hook

Runs after YAML processing. Use for:
- Swapping entities after all definitions loaded
- Rare cases requiring post-processing

## Best Practices

1. **Rename on production branch** - Avoid breaking production queries
2. **Update YAML files** - Change references in same deployment
3. **Use pre hook for renames** - Most common pattern
4. **Test migrations** - Verify in development first
5. **Document changes** - Add comments explaining why

## Important Notes

⚠️ **Production Branch Warning:**

Renaming on non-production branches can cause issues:
- Production queries reference old entity names
- Old names don't exist in your branch
- Queries may fail

**Best practice:** Only rename on production branch, or coordinate with team.

## Creating Migrations

Use the CLI to create migrations:

```bash
# Rename
strata create migration rename \
  --entity dimension \
  --from "Store Name" \
  --to "Store Location Name"

# Swap
strata create migration swap \
  --entity measure \
  --from "Old Revenue" \
  --to "New Revenue"
```

## Next Steps

- [Learn about migrations](/docs/guides/migrations)
- [Read about deployment](/docs/guides/deployment)
