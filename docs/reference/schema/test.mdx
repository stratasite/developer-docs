# Test Schema (tests/*.yml)

Complete schema for test definition files.

## Overview

Tests validate that the Planner generates correct SQL from your semantic model.

## File Pattern

`tests/{test_name}.yml`

## Schema

```yaml
# Required
name: string                    # Test display name
projections: array              # Array of field names to query

# At least one assertion required
assert_sql: string              # Exact SQL assertion
assert_regex: string            # Regex pattern assertion

# Optional
filters: array                  # Filter conditions
```

## Required Fields

### name

Display name for the test.

```yaml
name: Store Sales Positive Values
```

### projections

List of semantic field names to query. Must match field names in your model.

```yaml
projections:
  - Store Sales Price
  - Store Quantity
  - Order Count
```

### Assertions

At least one assertion is required:

#### assert_sql

Exact SQL match. Whitespace is normalized for comparison.

```yaml
assert_sql: "SELECT sum(T0.\"ss_quantity\") AS \"Store Quantity\", sum(T0.\"ss_sales_price\") AS \"Store Sales Price\" FROM store_sales T0"
```

**Notes:**
- Must match exactly (case-sensitive)
- Whitespace normalized (tabs/newlines become spaces)
- Use for precise validation

#### assert_regex

Regex pattern match (more flexible).

```yaml
assert_regex: "c_email_address"
```

**Use cases:**
- Partial matching
- Flexible column names
- Testing specific patterns

## Optional Fields

### filters

Filter conditions for the query.

```yaml
filters:
  - dimension: Order Date
    predicate: between
    filter_value: 2024-01-01
    filter_value_end: 2024-12-31

  - measure: Total Revenue
    predicate: greater_than
    filter_value: 1000
```

**Filter structure:**
```yaml
- dimension: string              # Dimension name
  predicate: string             # Predicate type
  filter_value: string          # Filter value
  filter_value_end: string      # Optional: End value (for between)

- measure: string               # Measure name
  predicate: string             # Predicate type
  filter_value: string          # Filter value
```

## Complete Examples

### Simple Measure Test

```yaml
name: Total Revenue Calculation

projections:
  - Total Revenue

assert_sql: "SELECT sum(T0.\"amount\") AS \"Total Revenue\" FROM orders T0"
```

### Multiple Projections

```yaml
name: Sales Summary

projections:
  - Store Sales Price
  - Store Quantity
  - Order Count

assert_sql: "SELECT sum(T0.\"ss_quantity\") AS \"Store Quantity\", count(*) AS \"Order Count\", sum(T0.\"ss_sales_price\") AS \"Store Sales Price\" FROM store_sales T0"
```

### With Filters

```yaml
name: Recent Orders

projections:
  - Order Count
  - Total Revenue

filters:
  - dimension: Order Date
    predicate: between
    filter_value: 2024-01-01
    filter_value_end: 2024-12-31

assert_sql: "SELECT count(*) AS \"Order Count\", sum(T0.\"amount\") AS \"Total Revenue\" FROM orders T0 WHERE T0.\"order_date\" BETWEEN '2024-01-01' AND '2024-12-31'"
```

### Regex Assertion

```yaml
name: Customer Email Validation

projections:
  - Customer Email

assert_regex: "c_email_address"
```

## Test Execution

Tests run automatically during deployment:

```bash
strata deploy
```

**Process:**
1. YAML files validated
2. Models deployed to server
3. Tests executed
4. Results reported

**If tests fail:**
- Deployment may be blocked
- Review test output
- Fix model or update test expectations

## Best Practices

1. **Test critical queries** - Focus on important business metrics
2. **Use SQL assertions** - For exact validation
3. **Use regex assertions** - For flexible patterns
4. **Test edge cases** - Filters, aggregations, joins
5. **Update tests** - When models change
6. **Name descriptively** - Clear test purpose

## Troubleshooting

### Test Fails

**Check:**
- SQL matches exactly (whitespace normalized)
- Field names match model definitions
- Test file syntax is valid

**Solution:**
- Review test output
- Update test expectations
- Fix model definitions

### Field Not Found

**Check:**
- Field name matches exactly (case-sensitive)
- Field exists in deployed model
- Field is in correct table

**Solution:**
- Verify field names
- Check model definitions
- Update test

## Next Steps

- [Learn about testing](/docs/guides/testing)
- [Read about deployment](/docs/guides/deployment)
